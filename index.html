<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>基礎記帳 + AI 辨識版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f9fafb; }
        .mobile-container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: white; position: relative; padding-bottom: 90px; }
        .input-label { display: block; font-size: 0.85rem; color: #4b5563; margin-bottom: 4px; font-weight: 500; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s; -webkit-appearance: none; background: #fff; }
        .input-field:focus { border-color: #2563eb; outline: none; ring: 2px solid #bfdbfe; }
        .btn-primary { background: #2563eb; color: white; padding: 12px; border-radius: 8px; width: 100%; font-weight: 600; text-align: center; box-shadow: 0 2px 4px rgba(37,99,235,0.2); }
        .btn-secondary { background: #f3f4f6; color: #4b5563; padding: 12px; border-radius: 8px; width: 100%; font-weight: 600; text-align: center; }
        /* 隱藏捲軸但保留功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* 載入動畫 */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #2563eb; width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. 設定區 ---
        const firebaseConfig = {
          apiKey: "AIzaSyCzJrM3jdvmRMvv_0ln7mrEoJzlpp0u-nw",
          authDomain: "travel-expense-1c058.firebaseapp.com",
          projectId: "travel-expense-1c058",
          storageBucket: "travel-expense-1c058.firebasestorage.app",
          messagingSenderId: "248802295771",
          appId: "1:248802295771:web:2a49b4f9cbc0c27fda71fe",
          measurementId: "G-L01PRNHE28"
        };
        
        // 您的 Gemini API Key 預設值
        const DEFAULT_GEMINI_KEY = "AIzaSyC92ceFCXbcINuovR9U49y9i4eVNOCrj04";

        // --- 2. 初始化 Firebase ---
        let app, auth, db;
        try {
            if (!firebase.apps.length) app = firebase.initializeApp(firebaseConfig);
            else app = firebase.app();
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (e) {
            document.body.innerHTML = `<div style="padding:20px;color:red">Firebase Error: ${e.message}</div>`;
        }

        const appId = firebaseConfig.projectId;
        const categories = ["飲食", "交通", "住宿", "購物", "門票", "其他"];
        const currencies = ["TWD", "JPY", "KRW", "USD", "EUR", "CNY", "THB", "VND"];

        // --- 3. 輔助功能 ---
        const formatMoney = (amount, currency = 'TWD') => {
            return new Intl.NumberFormat('zh-TW', { 
                style: 'currency', 
                currency: currency, 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 2 
            }).format(amount);
        };

        // --- 4. 主程式 ---
        const App = () => {
            const [user, setUser] = React.useState(null);
            const [view, setView] = React.useState('login'); 
            const [tripId, setTripId] = React.useState('');
            // 加入 API Key 狀態管理
            const [apiKey, setApiKey] = React.useState(localStorage.getItem('gemini_api_key') || DEFAULT_GEMINI_KEY);
            const [expenses, setExpenses] = React.useState([]);
            const [editItem, setEditItem] = React.useState(null);

            // 自動登入
            React.useEffect(() => {
                auth.signInAnonymously().catch(e => console.error("Auth:", e));
                auth.onAuthStateChanged(u => setUser(u));
            }, []);

            // 資料同步 (維持原本的資料路徑)
            React.useEffect(() => {
                if (!user || !tripId) return;
                const ref = db.collection('artifacts').doc(appId)
                              .collection('public').doc('data')
                              .collection(`${tripId}_simple_v1`);
                              
                const unsub = ref.orderBy('createdAt', 'desc').onSnapshot(snap => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setExpenses(data);
                });
                return () => unsub();
            }, [user, tripId]);

            // 處理登入
            const handleLogin = (code, key) => {
                if (!code.trim()) return alert("請輸入代號");
                setTripId(code.toUpperCase());
                
                // 儲存新的 Key (如果有改動)
                if (key) {
                    setApiKey(key);
                    localStorage.setItem('gemini_api_key', key);
                }

                setView('list');
            };

            // 處理儲存
            const handleSave = async (data) => {
                try {
                    const ref = db.collection('artifacts').doc(appId)
                                  .collection('public').doc('data')
                                  .collection(`${tripId}_simple_v1`);
                    if (data.id) {
                        const { id, ...updateData } = data;
                        await ref.doc(id).update(updateData);
                    } else {
                        await ref.add({ 
                            ...data, 
                            createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                        });
                    }
                    setView('list');
                    setEditItem(null);
                } catch (e) {
                    alert("儲存失敗: " + e.message);
                }
            };

            const handleDelete = async (id) => {
                if(!confirm("確定要刪除嗎？")) return;
                await db.collection('artifacts').doc(appId)
                        .collection('public').doc('data')
                        .collection(`${tripId}_simple_v1`)
                        .doc(id).delete();
            };

            const totalTWD = expenses.reduce((sum, item) => sum + Number(item.twdAmount || 0), 0);

            return (
                <div className="mobile-container">
                    {view === 'login' ? (
                        <LoginView onLogin={handleLogin} defaultKey={apiKey} />
                    ) : (
                        <>
                            <Header tripId={tripId} total={totalTWD} onLogout={() => window.location.reload()} />
                            
                            <div className="p-4">
                                {view === 'list' && (
                                    <ExpenseList 
                                        expenses={expenses} 
                                        onEdit={(item) => { setEditItem(item); setView('add'); }}
                                        onDelete={handleDelete}
                                    />
                                )}
                                {view === 'add' && (
                                    <AddForm 
                                        apiKey={apiKey}
                                        initialData={editItem} 
                                        onSave={handleSave} 
                                        onCancel={() => { setView('list'); setEditItem(null); }} 
                                    />
                                )}
                            </div>

                            {view === 'list' && (
                                <button 
                                    onClick={() => setView('add')}
                                    className="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-blue-700 active:scale-95 transition-transform z-20"
                                >
                                    <i className="fa-solid fa-plus"></i>
                                </button>
                            )}
                        </>
                    )}
                </div>
            );
        };

        // --- 子元件 ---

        const LoginView = ({ onLogin, defaultKey }) => {
            const [code, setCode] = React.useState(localStorage.getItem('last_trip_code') || '');
            const [key, setKey] = React.useState(defaultKey);

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gray-50">
                    <div className="bg-white p-8 rounded-2xl shadow-sm w-full max-w-sm text-center">
                        <div className="text-4xl text-blue-600 mb-4"><i className="fa-solid fa-wallet"></i></div>
                        <h1 className="text-xl font-bold text-gray-800 mb-6">記帳系統 + AI</h1>
                        
                        <div className="text-left mb-4">
                            <label className="input-label">旅程代號</label>
                            <input 
                                value={code} 
                                onChange={e => setCode(e.target.value)}
                                className="input-field uppercase text-center font-bold tracking-widest"
                                placeholder="例如 JAPAN2024"
                            />
                        </div>

                        <div className="text-left mb-6">
                            <label className="input-label">Gemini API Key</label>
                            <input 
                                type="password"
                                value={key} 
                                onChange={e => setKey(e.target.value)}
                                className="input-field text-sm"
                                placeholder="貼上 API Key"
                            />
                        </div>

                        <button 
                            onClick={() => {
                                localStorage.setItem('last_trip_code', code);
                                onLogin(code, key);
                            }} 
                            className="btn-primary"
                        >
                            開始記帳
                        </button>
                    </div>
                </div>
            );
        };

        const Header = ({ tripId, total, onLogout }) => (
            <div className="bg-blue-600 text-white p-4 sticky top-0 z-10 shadow-md">
                <div className="flex justify-between items-start mb-2">
                    <div>
                        <span className="text-blue-200 text-xs uppercase tracking-wider">Project</span>
                        <h2 className="font-bold text-lg">{tripId}</h2>
                    </div>
                    <button onClick={onLogout} className="text-blue-200 hover:text-white"><i className="fa-solid fa-arrow-right-from-bracket"></i></button>
                </div>
                <div>
                    <span className="text-blue-200 text-xs">目前總花費 (TWD)</span>
                    <div className="text-3xl font-bold">{formatMoney(total).replace('NT$', '$')}</div>
                </div>
            </div>
        );

        const ExpenseList = ({ expenses, onEdit, onDelete }) => {
            if (expenses.length === 0) return (
                <div className="text-center py-20 text-gray-400">
                    <i className="fa-regular fa-clipboard text-4xl mb-3"></i>
                    <p>還沒有記帳紀錄</p>
                </div>
            );

            return (
                <div className="space-y-3 pb-20">
                    {expenses.map(item => (
                        <div 
                            key={item.id} 
                            onClick={() => onEdit(item)}
                            className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center active:bg-gray-50"
                        >
                            <div className="flex-1">
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs font-medium">
                                        {item.category}
                                    </span>
                                    <span className="font-medium text-gray-800">{item.item || "未命名"}</span>
                                </div>
                                <div className="text-xs text-gray-400">
                                    {item.currency !== 'TWD' && (
                                        <span className="mr-1">
                                            {item.currency} {Number(item.foreignAmount).toLocaleString()}
                                        </span>
                                    )}
                                    {item.currency !== 'TWD' && <span>≈ </span>}
                                    {new Date(item.createdAt?.seconds * 1000).toLocaleDateString()}
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="text-right">
                                    <div className="font-bold text-gray-800">{formatMoney(item.twdAmount)}</div>
                                </div>
                                <button 
                                    onClick={(e) => { e.stopPropagation(); onDelete(item.id); }}
                                    className="text-gray-300 hover:text-red-500 px-2"
                                >
                                    <i className="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const AddForm = ({ apiKey, initialData, onSave, onCancel }) => {
            const [form, setForm] = React.useState({
                category: '飲食',
                item: '',
                currency: 'JPY',
                foreignAmount: '',
                exchangeRate: 0.22,
                twdAmount: ''
            });
            const [loading, setLoading] = React.useState(false);
            const fileRef = React.useRef(null);

            React.useEffect(() => {
                if (initialData) setForm(initialData);
            }, [initialData]);

            // 自動計算台幣
            React.useEffect(() => {
                if (form.currency === 'TWD') {
                    setForm(p => ({ ...p, twdAmount: p.foreignAmount, exchangeRate: 1 }));
                } else if (form.foreignAmount && form.exchangeRate) {
                    const twd = Math.round(parseFloat(form.foreignAmount) * parseFloat(form.exchangeRate));
                    setForm(p => ({ ...p, twdAmount: twd }));
                }
            }, [form.foreignAmount, form.exchangeRate, form.currency]);

            // 處理圖片上傳與 AI 辨識
            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setLoading(true);
                try {
                    // 1. 轉 Base64
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = async () => {
                        const base64Data = reader.result.split(',')[1];
                        
                        // 2. 呼叫 Gemini
                        const prompt = `你是一個記帳助手。請辨識這張收據的內容。
                        請回傳一個 JSON 物件，格式如下 (不要用Markdown code block，直接回傳JSON):
                        {
                            "item": "品名摘要(繁體中文)",
                            "currency": "幣別(例如 TWD, JPY, KRW, USD)",
                            "amount": 金額數字,
                            "category": "建議類別(飲食, 交通, 住宿, 購物, 門票, 其他)"
                        }`;

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: prompt },
                                        { inlineData: { mimeType: file.type, data: base64Data } }
                                    ]
                                }]
                            })
                        });

                        const data = await response.json();
                        
                        // 3. 解析結果
                        if (data.candidates && data.candidates[0].content) {
                            const text = data.candidates[0].content.parts[0].text;
                            // 簡單的清理 JSON 字串
                            const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                            const result = JSON.parse(cleanText);

                            // 4. 填入表單 (預設類別需檢查是否存在於清單中)
                            setForm(prev => ({
                                ...prev,
                                item: result.item || prev.item,
                                currency: result.currency || prev.currency,
                                foreignAmount: result.amount || prev.foreignAmount,
                                category: categories.includes(result.category) ? result.category : '購物'
                            }));
                            
                            alert("辨識完成！請檢查並勾選「確認儲存」。");
                        } else {
                            throw new Error("無法解析回應");
                        }
                    };
                } catch (error) {
                    console.error(error);
                    alert("辨識失敗，請手動輸入。\n錯誤訊息: " + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                    <h2 className="text-lg font-bold text-gray-800 mb-4 border-b pb-2 flex justify-between items-center">
                        <span>{initialData ? '修改花費' : '新增花費'}</span>
                        {/* AI 相機按鈕 */}
                        <button 
                            onClick={() => fileRef.current.click()}
                            disabled={loading}
                            className="text-sm bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg flex items-center gap-2 hover:bg-blue-100 transition-colors"
                        >
                            {loading ? <div className="loader"></div> : <i className="fa-solid fa-camera"></i>}
                            <span>{loading ? '辨識中...' : '拍收據'}</span>
                        </button>
                        <input 
                            type="file" 
                            ref={fileRef} 
                            accept="image/*" 
                            capture="environment" 
                            className="hidden" 
                            onChange={handleImageUpload} 
                        />
                    </h2>

                    <div className="space-y-4">
                        {/* 類別選擇 */}
                        <div>
                            <label className="input-label">分類</label>
                            <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                                {categories.map(c => (
                                    <button 
                                        key={c}
                                        onClick={() => setForm({...form, category: c})}
                                        className={`px-4 py-2 rounded-lg text-sm whitespace-nowrap border transition-colors ${
                                            form.category === c 
                                            ? 'bg-blue-600 text-white border-blue-600' 
                                            : 'bg-white text-gray-500 border-gray-200'
                                        }`}
                                    >
                                        {c}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* 品名 */}
                        <div>
                            <label className="input-label">品名</label>
                            <input 
                                value={form.item}
                                onChange={e => setForm({...form, item: e.target.value})}
                                className="input-field"
                                placeholder="例如：便利商店"
                            />
                        </div>

                        {/* 金額計算區 */}
                        <div className="grid grid-cols-3 gap-3">
                            <div>
                                <label className="input-label">幣別</label>
                                <select 
                                    value={form.currency}
                                    onChange={e => setForm({...form, currency: e.target.value})}
                                    className="input-field bg-white"
                                >
                                    {currencies.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <div className="col-span-2">
                                <label className="input-label">金額</label>
                                <input 
                                    type="number"
                                    inputMode="decimal"
                                    value={form.foreignAmount}
                                    onChange={e => setForm({...form, foreignAmount: e.target.value})}
                                    className="input-field font-mono text-lg font-medium"
                                    placeholder="0.00"
                                />
                            </div>
                        </div>

                        {/* 匯率與台幣預覽 (非台幣時顯示) */}
                        {form.currency !== 'TWD' && (
                            <div className="bg-gray-50 p-4 rounded-xl grid grid-cols-3 gap-3 border border-gray-100">
                                <div>
                                    <label className="input-label text-xs">匯率</label>
                                    <input 
                                        type="number"
                                        inputMode="decimal"
                                        value={form.exchangeRate}
                                        onChange={e => setForm({...form, exchangeRate: e.target.value})}
                                        className="input-field text-sm p-2"
                                    />
                                </div>
                                <div className="col-span-2">
                                    <label className="input-label text-xs text-blue-600">折合台幣</label>
                                    <input 
                                        value={form.twdAmount}
                                        readOnly
                                        className="input-field text-blue-600 font-bold bg-transparent border-none p-2"
                                    />
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="flex gap-3 mt-8">
                        <button onClick={onCancel} className="btn-secondary">取消</button>
                        <button onClick={() => onSave(form)} className="btn-primary">
                            <i className="fa-solid fa-check mr-2"></i>
                            確認儲存 (計入帳冊)
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>