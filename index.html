<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>旅行代購記帳神器 V3 (修復版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs (Compat Version for file:// support) -->
    <!-- 使用 Compat 版本以確保直接開啟檔案時也能運作 -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .mobile-container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: white; position: relative; padding-bottom: 80px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 16px; margin-bottom: 12px; }
        .input-group { margin-bottom: 12px; }
        .input-label { display: block; font-size: 0.85rem; color: #6b7280; margin-bottom: 4px; }
        .input-field { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s; }
        .input-field:focus { border-color: #3b82f6; outline: none; ring: 2px solid #bfdbfe; }
        .btn-primary { background: #3b82f6; color: white; padding: 12px; border-radius: 8px; width: 100%; font-weight: 600; text-align: center; }
        .btn-secondary { background: #e5e7eb; color: #374151; padding: 12px; border-radius: 8px; width: 100%; font-weight: 600; text-align: center; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6; width: 24px; height: 24px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Hide scrollbar for category selector */
        .category-scroll::-webkit-scrollbar { display: none; }
        .category-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Error Box */
        #error-display { display: none; padding: 20px; background: #fee2e2; color: #991b1b; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; }
    </style>
</head>
<body>
    <div id="error-display"></div>
    <div id="root"></div>

    <script>
        // Global Error Handler
        window.onerror = function(message, source, lineno, colno, error) {
            const display = document.getElementById('error-display');
            display.style.display = 'block';
            display.innerHTML = `<strong>系統發生錯誤：</strong><br>${message}<br><small>Line: ${lineno}</small>`;
        };
    </script>

    <script type="text/babel">
        // --- Configuration Section ---
        
        const firebaseConfig = {
          apiKey: "AIzaSyCzJrM3jdvmRMvv_0ln7mrEoJzlpp0u-nw",
          authDomain: "travel-expense-1c058.firebaseapp.com",
          projectId: "travel-expense-1c058",
          storageBucket: "travel-expense-1c058.firebasestorage.app",
          messagingSenderId: "248802295771",
          appId: "1:248802295771:web:2a49b4f9cbc0c27fda71fe",
          measurementId: "G-L01PRNHE28"
        };

        const DEFAULT_GEMINI_KEY = "AIzaSyC92ceFCXbcINuovR9U49y9i4eVNOCrj04";

        // --- Firebase Initialization (Compat Mode) ---
        let app, auth, db;
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            auth = firebase.auth();
            db = firebase.firestore();
            console.log("Firebase initialized successfully");
        } catch (e) {
            console.error("Firebase init error:", e);
            document.getElementById('error-display').style.display = 'block';
            document.getElementById('error-display').innerHTML = "Firebase 連線失敗: " + e.message;
        }

        const appId = firebaseConfig.projectId || 'travel-expense-v1';
        const categories = ["飲食", "交通", "住宿", "購物", "門票", "其他", "代購"];
        const currencies = ["TWD", "JPY", "KRW", "USD", "EUR", "CNY", "THB", "VND"];

        // Utility
        const formatMoney = (amount, currency) => {
            return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: currency || 'TWD', minimumFractionDigits: 0 }).format(amount);
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [view, setView] = React.useState('login'); 
            const [tripId, setTripId] = React.useState('');
            const [apiKey, setApiKey] = React.useState(localStorage.getItem('gemini_api_key') || DEFAULT_GEMINI_KEY);
            const [expenses, setExpenses] = React.useState([]);
            const [loginHistory, setLoginHistory] = React.useState([]);
            const [editItem, setEditItem] = React.useState(null);

            // Auth & History Load
            React.useEffect(() => {
                const initAuth = async () => {
                    try {
                        await auth.signInAnonymously();
                    } catch (error) { console.error("Auth failed", error); }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged((u) => setUser(u));
                
                const savedHistory = JSON.parse(localStorage.getItem('trip_history') || '[]');
                setLoginHistory(savedHistory);
                
                const savedKey = localStorage.getItem('gemini_api_key');
                if (savedKey) setApiKey(savedKey);

                return () => unsubscribe();
            }, []);

            // Firestore Data Sync (Compat Syntax)
            React.useEffect(() => {
                if (!user || !tripId) return;
                
                // Path: artifacts/{appId}/public/data/{tripId}_expenses
                const collectionRef = db.collection('artifacts')
                                        .doc(appId)
                                        .collection('public')
                                        .doc('data')
                                        .collection(`${tripId}_expenses`);

                const unsubscribe = collectionRef
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setExpenses(data);
                    }, (error) => {
                        console.error("Error fetching data:", error);
                        // If index error, we fallback to client side sorting (rare for simple queries)
                    });
                    
                return () => unsubscribe();
            }, [user, tripId]);

            // Handlers
            const handleLogin = (code, key) => {
                if (!code) return alert("請輸入旅程代號");
                if (!key) return alert("請輸入 Gemini API Key");
                
                setTripId(code);
                setApiKey(key);
                localStorage.setItem('gemini_api_key', key);
                
                const newHistory = [code, ...loginHistory.filter(h => h !== code)].slice(0, 5);
                setLoginHistory(newHistory);
                localStorage.setItem('trip_history', JSON.stringify(newHistory));
                setView('list');
            };

            const handleLogout = () => {
                setTripId('');
                setExpenses([]);
                setView('login');
            };

            const handleDelete = async (id) => {
                if (!confirm("確定要刪除這筆資料嗎？")) return;
                try {
                    await db.collection('artifacts').doc(appId)
                            .collection('public').doc('data')
                            .collection(`${tripId}_expenses`).doc(id).delete();
                } catch(e) {
                    alert("刪除失敗: " + e.message);
                }
            };

            const handleSaveItem = async (itemData) => {
                try {
                    const collectionRef = db.collection('artifacts').doc(appId)
                                            .collection('public').doc('data')
                                            .collection(`${tripId}_expenses`);
                    
                    if (itemData.id) {
                        const { id, ...updateData } = itemData;
                        await collectionRef.doc(id).update(updateData);
                    } else {
                        await collectionRef.add({
                            ...itemData,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    setView('list');
                    setEditItem(null);
                } catch (e) {
                    alert("儲存失敗: " + e.message);
                    console.error(e);
                }
            };

            return (
                <div className="mobile-container">
                    {view === 'login' && <LoginView history={loginHistory} savedKey={apiKey} onLogin={handleLogin} />}
                    {view !== 'login' && (
                        <>
                            <Header tripId={tripId} currentView={view} onBack={() => { setView('list'); setEditItem(null); }} onLogout={handleLogout} />
                            <div className="p-4">
                                {view === 'list' && <ExpenseList expenses={expenses} onEdit={(item) => { setEditItem(item); setView('add'); }} onDelete={handleDelete} />}
                                {view === 'add' && <AddEditForm apiKey={apiKey} initialData={editItem} onSave={handleSaveItem} onCancel={() => { setEditItem(null); setView('list'); }} />}
                                {view === 'stats' && <StatsView expenses={expenses} />}
                            </div>
                            <BottomNav currentView={view} onChange={(v) => { if(v === 'add') setEditItem(null); setView(v); }} />
                        </>
                    )}
                </div>
            );
        };

        const LoginView = ({ history, savedKey, onLogin }) => {
            const [code, setCode] = React.useState('');
            const [key, setKey] = React.useState(savedKey || DEFAULT_GEMINI_KEY);
            
            return (
                <div className="p-6 flex flex-col items-center justify-center min-h-screen bg-blue-50">
                    <div className="w-full max-w-sm">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-blue-600 mb-2">旅行代購記帳</h1>
                            <p className="text-gray-500">雲端同步 · AI 辨識 · 相容模式</p>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-lg">
                            <label className="input-label">旅程代號 (例如：JAPAN2024)</label>
                            <input type="text" value={code} onChange={e => setCode(e.target.value.toUpperCase())} className="input-field mb-4 uppercase" placeholder="輸入代號" />
                            
                            <label className="input-label">Gemini API Key</label>
                            <input type="password" value={key} onChange={e => setKey(e.target.value)} className="input-field mb-6" placeholder="貼上 AI Studio 金鑰" />
                            
                            <button onClick={() => onLogin(code, key)} className="btn-primary mb-4 shadow-md">進入記帳</button>
                            {history.length > 0 && (
                                <div className="mt-4">
                                    <p className="text-xs text-gray-400 mb-2">歷史代號：</p>
                                    <div className="flex flex-wrap gap-2">
                                        {history.map(h => (
                                            <button key={h} onClick={() => setCode(h)} className="bg-gray-100 px-3 py-1 rounded-full text-sm text-gray-600 hover:bg-gray-200">{h}</button>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const Header = ({ tripId, currentView, onBack, onLogout }) => (
            <div className="bg-white px-4 py-3 shadow-sm sticky top-0 z-10 flex justify-between items-center border-b">
                <div className="flex items-center">
                    {currentView !== 'list' && (
                        <button onClick={onBack} className="mr-3 text-gray-600"><i className="fa-solid fa-arrow-left text-lg"></i></button>
                    )}
                    <div>
                        <h2 className="font-bold text-lg text-gray-800">{tripId}</h2>
                        <span className="text-xs text-green-600 bg-green-100 px-2 py-0.5 rounded-full">● 已連線</span>
                    </div>
                </div>
                <button onClick={onLogout} className="text-gray-400 hover:text-red-500"><i className="fa-solid fa-power-off"></i></button>
            </div>
        );

        const BottomNav = ({ currentView, onChange }) => (
            <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around py-3 pb-safe z-20 mobile-container mx-auto">
                <button onClick={() => onChange('list')} className={`flex flex-col items-center ${currentView === 'list' ? 'text-blue-600' : 'text-gray-400'}`}>
                    <i className="fa-solid fa-list-ul mb-1 text-xl"></i><span className="text-xs">明細</span>
                </button>
                <button onClick={() => onChange('add')} className="flex flex-col items-center justify-center -mt-8">
                    <div className="bg-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg shadow-blue-200 transform active:scale-95 transition-transform">
                        <i className="fa-solid fa-plus text-2xl"></i>
                    </div>
                </button>
                <button onClick={() => onChange('stats')} className={`flex flex-col items-center ${currentView === 'stats' ? 'text-blue-600' : 'text-gray-400'}`}>
                    <i className="fa-solid fa-chart-pie mb-1 text-xl"></i><span className="text-xs">統計</span>
                </button>
            </div>
        );

        const ExpenseList = ({ expenses, onEdit, onDelete }) => {
            if (expenses.length === 0) return (
                <div className="flex flex-col items-center justify-center h-64 text-gray-400">
                    <i className="fa-solid fa-receipt text-4xl mb-3"></i><p>尚無花費紀錄</p><p className="text-sm">按 + 開始記帳</p>
                </div>
            );
            return (
                <div className="pb-20 space-y-3">
                    {expenses.map(item => (
                        <div key={item.id} className="card flex justify-between items-start relative active:bg-gray-50 transition-colors" onClick={() => onEdit(item)}>
                            <div className="flex-1">
                                <div className="flex justify-between items-start mb-1">
                                    <h3 className="font-bold text-gray-800 text-lg">{item.item || "未命名項目"}</h3>
                                    <span className="font-bold text-gray-900">{formatMoney(item.twdAmount)}</span>
                                </div>
                                <div className="flex items-center text-sm text-gray-500 flex-wrap gap-1">
                                    <span className={`px-2 py-0.5 rounded text-xs ${item.category === '代購' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100'}`}>
                                        {item.category}{item.category === '代購' && ` - ${item.agencyName}`}
                                    </span>
                                    {item.currency !== 'TWD' && <span className="text-gray-400 text-xs">({item.currency} {item.foreignAmount})</span>}
                                </div>
                            </div>
                            <button onClick={(e) => { e.stopPropagation(); onDelete(item.id); }} className="ml-2 p-2 text-gray-300 hover:text-red-500"><i className="fa-regular fa-trash-can"></i></button>
                        </div>
                    ))}
                </div>
            );
        };

        const AddEditForm = ({ apiKey, initialData, onSave, onCancel }) => {
            const [formData, setFormData] = React.useState({
                category: '飲食', agencyName: '', item: '', currency: 'JPY', foreignAmount: '', exchangeRate: 0.22, twdAmount: ''
            });
            const [isProcessing, setIsProcessing] = React.useState(false);
            const fileInputRef = React.useRef(null);

            React.useEffect(() => { if (initialData) setFormData(initialData); }, [initialData]);

            React.useEffect(() => {
                if (formData.currency === 'TWD') {
                    setFormData(prev => ({ ...prev, twdAmount: prev.foreignAmount, exchangeRate: 1 }));
                } else if (formData.foreignAmount && formData.exchangeRate) {
                    const twd = Math.round(parseFloat(formData.foreignAmount) * parseFloat(formData.exchangeRate));
                    setFormData(prev => ({ ...prev, twdAmount: twd }));
                }
            }, [formData.foreignAmount, formData.exchangeRate, formData.currency]);

            const handleChange = (field, value) => setFormData(prev => ({ ...prev, [field]: value }));

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsProcessing(true);
                try {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = async () => {
                        const base64Data = reader.result.split(',')[1];
                        const prompt = `你是一個記帳助手。請辨識收據。回傳JSON物件:{ "item": "品名(繁中)", "currency": "幣別代碼(JPY/KRW/TWD/USD)", "amount": 數字, "category": "類別(飲食/交通/住宿/購物/代購)" }`;
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: file.type, data: base64Data } }] }] })
                        });
                        const data = await response.json();
                        const result = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim());
                        setFormData(prev => ({
                            ...prev, item: result.item, currency: result.currency, foreignAmount: result.amount, category: categories.includes(result.category) ? result.category : '購物'
                        }));
                    };
                } catch (error) { alert("辨識失敗: " + error.message); } finally { setIsProcessing(false); }
            };

            return (
                <div className="bg-white rounded-xl shadow-sm p-4 pb-20">
                    <div className="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100 flex justify-between items-center">
                        <div><h3 className="font-bold text-blue-800">懶人記帳</h3><p className="text-xs text-blue-600">拍照自動填入下方欄位</p></div>
                        <button onClick={() => fileInputRef.current.click()} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow active:bg-blue-700 flex items-center" disabled={isProcessing}>
                            {isProcessing ? <div className="loader mr-2"></div> : <i className="fa-solid fa-camera mr-2"></i>}
                            {isProcessing ? '辨識中...' : '拍收據'}
                        </button>
                        <input type="file" ref={fileInputRef} className="hidden" accept="image/*" capture="environment" onChange={handleImageUpload} />
                    </div>

                    <div className="border-t border-gray-100 pt-4">
                        <h4 className="text-sm font-bold text-gray-500 mb-3 uppercase tracking-wider">手動輸入明細</h4>
                        <div className="mb-4">
                            <label className="input-label">消費類別</label>
                            <div className="flex gap-2 overflow-x-auto category-scroll pb-1">
                                {categories.map(c => (
                                    <button key={c} onClick={() => handleChange('category', c)}
                                        className={`px-3 py-1.5 rounded-full text-sm whitespace-nowrap border ${formData.category === c ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-600 border-gray-200'}`}>
                                        {c}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {formData.category === '代購' && (
                            <div className="mb-4 bg-purple-50 p-3 rounded-lg border border-purple-100">
                                <label className="input-label text-purple-800">代購給誰？</label>
                                <input type="text" value={formData.agencyName} onChange={e => handleChange('agencyName', e.target.value)} className="input-field border-purple-200 focus:ring-purple-200" placeholder="例如：小美" autoFocus />
                            </div>
                        )}

                        <div className="input-group">
                            <label className="input-label">品名</label>
                            <input type="text" value={formData.item} onChange={e => handleChange('item', e.target.value)} className="input-field" placeholder="輸入商品名稱" />
                        </div>

                        <div className="grid grid-cols-3 gap-3 mb-4">
                            <div>
                                <label className="input-label">幣別</label>
                                <select value={formData.currency} onChange={e => handleChange('currency', e.target.value)} className="input-field bg-white">
                                    {currencies.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <div className="col-span-2">
                                <label className="input-label">金額</label>
                                <input type="number" inputMode="decimal" value={formData.foreignAmount} onChange={e => handleChange('foreignAmount', e.target.value)} className="input-field font-mono text-lg" placeholder="0.00" />
                            </div>
                        </div>

                        {formData.currency !== 'TWD' && (
                            <div className="grid grid-cols-3 gap-3 mb-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                <div>
                                    <label className="input-label">匯率</label>
                                    <input type="number" inputMode="decimal" value={formData.exchangeRate} onChange={e => handleChange('exchangeRate', e.target.value)} className="input-field text-sm" />
                                </div>
                                <div className="col-span-2">
                                    <label className="input-label text-blue-600 font-bold">折合台幣</label>
                                    <input type="number" value={formData.twdAmount} readOnly className="input-field font-bold text-blue-600 bg-transparent border-none p-2" />
                                </div>
                            </div>
                        )}

                        <div className="flex gap-3 mt-6">
                            <button onClick={onCancel} className="btn-secondary">取消</button>
                            <button onClick={() => onSave(formData)} className="btn-primary" disabled={formData.category === '代購' && !formData.agencyName}>
                                <i className="fa-solid fa-check mr-2"></i>確認儲存
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const StatsView = ({ expenses }) => {
            const grandTotalTWD = expenses.reduce((sum, item) => sum + Number(item.twdAmount || 0), 0);
            const personalExpenses = expenses.filter(item => item.category !== '代購');
            const personalTotalTWD = personalExpenses.reduce((sum, item) => sum + Number(item.twdAmount || 0), 0);
            
            const agencyMap = {};
            expenses.filter(i => i.category === '代購').forEach(item => {
                const name = item.agencyName || '未知';
                agencyMap[name] = (agencyMap[name] || 0) + Number(item.twdAmount || 0);
            });

            const currencyMap = {};
            personalExpenses.forEach(item => {
                const curr = item.currency;
                currencyMap[curr] = (currencyMap[curr] || 0) + Number(item.foreignAmount || 0);
            });

            return (
                <div className="pb-20 space-y-4">
                    <div className="card bg-blue-600 text-white">
                        <h3 className="text-blue-100 text-sm mb-1">個人總花費 (不含代購)</h3>
                        <p className="text-3xl font-bold mb-4">{formatMoney(personalTotalTWD)}</p>
                        <div className="border-t border-blue-500 pt-3">
                            <p className="text-xs text-blue-200 mb-2">外幣小計 (個人)：</p>
                            <div className="grid grid-cols-2 gap-2">
                                {Object.entries(currencyMap).map(([curr, amount]) => (
                                    <div key={curr} className="text-sm"><span className="opacity-70 w-8 inline-block">{curr}</span> <span className="font-mono">{amount.toLocaleString()}</span></div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {Object.keys(agencyMap).length > 0 && (
                        <div className="card border-l-4 border-purple-500">
                            <div className="flex justify-between items-end mb-3">
                                <h3 className="font-bold text-gray-700">代購收款清單</h3>
                                <span className="text-purple-600 font-bold">{formatMoney(grandTotalTWD - personalTotalTWD)}</span>
                            </div>
                            <div className="space-y-2">
                                {Object.entries(agencyMap).map(([name, amount]) => (
                                    <div key={name} className="flex justify-between items-center p-2 bg-purple-50 rounded">
                                        <span className="text-gray-700 font-medium"><i className="fa-solid fa-user-tag mr-2 text-purple-400"></i>{name}</span>
                                        <span className="font-bold text-gray-800">{formatMoney(amount)}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="text-center text-gray-400 text-sm mt-8">
                        <p>旅程總流水帳金額 (含代購)</p>
                        <p className="text-xl font-bold text-gray-600">{formatMoney(grandTotalTWD)}</p>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>